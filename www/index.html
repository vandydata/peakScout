<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">Get genes for your peaks - peakScout</title>
  <meta name="description" content="peakScout is a user-friendly and reversible peak-to-gene translator for genomic peak calling results" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fzstd@0.1.1/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.svg" alt="PeakScout Logo" class="header-logo" />
      <p class="header-description">peakScout is a user-friendly and reversible peak-to-gene translator for genomic peak calling results</p>
      <div class="header-links">
        <a href="#" class="header-link" title="Research article (coming soon)">
          <span class="material-symbols-outlined">article</span>
          DOI
        </a>
        <a href="https://github.com/vandydata/peakScout" class="header-link" title="View source code">
          <span class="material-symbols-outlined">code</span>
          GitHub
        </a>
      </div>
    </div>

    <div class="form-container">
      <form id="peakscoutForm">
        <div class="form-group">
          <label for="peakFile">Peak File</label>
          <div class="form-hint">Select MACS2, SEACR or BED file (max 4.5 MB)</div>
          <div class="file-upload">
            <input type="file" id="peakFile" accept=".bed,.narrowPeak,.txt" required />
            <div class="file-upload-label" id="fileLabel"><span class="material-symbols-outlined">folder_open</span> Choose your peak file...</div>
          </div>
          <div class="validation-error" id="fileError">Please select a valid file under 4.5 MB</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Peak Type</label>
            <div class="form-hint">Select your peak caller format</div>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="peakTypeBED6" name="peakType" value="BED6" required />
                <label for="peakTypeBED6">BED6</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="peakTypeMACS2" name="peakType" value="MACS2" required checked />
                <label for="peakTypeMACS2">MACS2</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="peakTypeSEACR" name="peakType" value="SEACR" required />
                <label for="peakTypeSEACR">SEACR</label>
              </div>
            </div>
            <div class="validation-error" id="peakTypeError">Please select a valid peak type</div>
          </div>
          <div class="form-group">
            <label>Number of Nearest Genes</label>
            <div class="form-hint">How many genes per peak</div>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="kValue1" name="kValue" value="1" required checked />
                <label for="kValue1">1</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="kValue2" name="kValue" value="2" required />
                <label for="kValue2">2</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="kValue3" name="kValue" value="3" required />
                <label for="kValue3">3</label>
              </div>
            </div>
            <div class="validation-error" id="kValueError">Please select a valid number of genes (1-3)</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="species">Species</label>
            <div class="form-hint">Reference genome used</div>
            <select id="species" required>
              <option value="dm6">Fruitfly (dm6)</option>
              <option value="xenTro10">Frog (xenTro10)</option>
              <option value="hg38" selected>Human (hg38)</option>
              <option value="hg19">Human (hg19)</option>
              <option value="mm10">Mouse (mm10)</option>
              <option value="mm39">Mouse (mm39)</option>
              <option value="susScr11">Pig (susScr11)</option>
              <option value="ce11">Worm (ce11)</option>
              <option value="sacCer3">Yeast (sacCer3)</option>
              <option value="danRer11">Zebrafish (danRer11)</option>
            </select>
            <div class="validation-error" id="speciesError">Please select a valid species</div>
          </div>
          <div class="form-group">
            <label>Output Format</label>
            <div class="form-hint">Choose download format</div>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="outputTypeXlsx" name="outputType" value="xlsx" required checked />
                <label for="outputTypeXlsx">Excel (.xlsx)</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="outputTypeCsv" name="outputType" value="csv" required />
                <label for="outputTypeCsv">CSV (.csv)</label>
              </div>
            </div>
            <div class="validation-error" id="outputTypeError">Please select a valid output format</div>
          </div>
          <!--<div class="form-group">
            <label for="outputName">Output Name</label>
            <input type="text" id="outputName" value=".peakscout" required />
          </div>-->
        </div>

        <button type="submit" class="submit-btn" id="submitBtn"><span class="material-symbols-outlined">search_insights</span> Run PeakScout Analysis</button>
      </form>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Running PeakScout analysis...</p>
        <small class="muted">This may take a few minutes</small>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <script>
    // Configuration
    // For local SAM: 'http://localhost:9000/2015-03-31/functions/function/invocations'
    // For API Gateway/Lambda URL: set to your deployed endpoint
    //const LAMBDA_ENDPOINT = 'http://localhost:9000/2015-03-31/functions/function/invocations';
    const LAMBDA_ENDPOINT = 'https://kc5rbxi6ve2fdvajzwvcdkeigi0hsnkb.lambda-url.us-east-1.on.aws/';

    // DOM 
    const form = document.getElementById('peakscoutForm');
    const fileInput = document.getElementById('peakFile');
    const fileLabel = document.getElementById('fileLabel');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');

    // Utilities
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024, sizes = ['Bytes','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
    function b64ToBytes(b64) { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
    function bytesToText(bytes) { return new TextDecoder().decode(bytes); }

    function unwrapLambda(result) {
      // Handle outer API Gateway/Lambda Proxy envelope
      if (result && typeof result === 'object' && 'body' in result) {
        if (result.isBase64Encoded) {
          const compressed = b64ToBytes(result.body);
          const jsonStr = pako.ungzip(compressed, { to: 'string' });
          return JSON.parse(jsonStr);
        }
        if (typeof result.body === 'string') {
          try { return JSON.parse(result.body); } catch { return result; }
        }
      }
      // Already unwrapped (local invoke)
      return result;
    }

    function saveTextAsCsv(filename, text) {
      const blob = new Blob([text], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename.endsWith('.csv') ? filename : `${filename}.csv`;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Decompress content_compressed payload to text
    function decompressToText(fileData) {
      if (!fileData) throw new Error('missing file data');

      // Compressed content path
      if (fileData.content_compressed && typeof fileData.content === 'string') {
        const bytes = b64ToBytes(fileData.content);
        if (fileData.compression_type === 'zstd') {
          const decompressed = fzstd.decompress(bytes);
          return bytesToText(decompressed);
        }
        if (fileData.compression_type === 'gzip') {
          return pako.ungzip(bytes, { to: 'string' });
        }
        // Unknown compression label. try raw text decode
        return bytesToText(bytes);
      }

      // Plain text path
      if (fileData.type === 'text' && typeof fileData.content === 'string') {
        return fileData.content;
      }

      // Boom!
      throw new Error('Not a text-CSV artifact (binary or unknown type).');
    }

    // Render CSV preview table (first N rows)
    function renderCsvPreview(container, csvText, rowLimit = 20) {
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    const rows = parsed.data.slice(0, rowLimit);

    if (!rows.length) {
      container.innerHTML = '<div class="muted">(No rows to preview)</div>';
      return;
    }

    // Determine field order (prefer Papa's meta, fallback to keys from first row)
    const fields = (parsed.meta && parsed.meta.fields && parsed.meta.fields.length)
      ? parsed.meta.fields
      : Object.keys(rows[0] || {});

    // Build table
    const tableWrap = document.createElement('div');
    tableWrap.className = 'table-scroll';
    const table = document.createElement('table');
    table.className = 'preview';

    // Header
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    fields.forEach((f) => {
      const th = document.createElement('th');
      th.textContent = f;
      if (f.toLowerCase().startsWith('closest_')) {
        th.classList.add('closest-col');
      }
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);

    // Body
    const tbody = document.createElement('tbody');
    rows.forEach((r) => {
      const tr = document.createElement('tr');
      // If r is an object (header:true), pull values by field name
      // If it somehow ends up an array, fall back to index acces
      fields.forEach((f, idx) => {
        const td = document.createElement('td');
        const val = (r && typeof r === 'object' && !Array.isArray(r)) ? r[f] : (r?.[idx]);
        td.title = (val ?? '').toString();
        td.textContent = (val ?? '').toString();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    // Inject into container
    container.innerHTML = '';
    container.appendChild(tableWrap);
    tableWrap.appendChild(table);
  }

    async function downloadOutputFile(filename, fileData, fallbackName='results') {
      try {
        // Binary base64 path
        if (fileData.type === 'binary_base64' && typeof fileData.content === 'string') {
          const b = b64ToBytes(fileData.content);
          const blob = new Blob([b]);
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename || `${fallbackName}.bin`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          return;
        }

        // Text path (possibly compressed)
        const text = decompressToText(fileData);
        saveTextAsCsv(filename || `${fallbackName}.csv`, text);
      } catch (err) {
        console.error('Download failed:', err);
        alert(`Failed to download ${filename}: ${err.message}`);
      }
    }

    function showError(message) {
      results.innerHTML = `<div class="error"><h3><span class="material-symbols-outlined">error</span> Error</h3><p>${message}</p></div>`;
      results.classList.add('show');
    }

    function displayResults(raw, outputName) {
      const data = unwrapLambda(raw);

      // If inner object has returncode, use it; else assume OK (local dev variants)
      const ok = (typeof data.returncode === 'number') ? (data.returncode === 0) : true;
      results.innerHTML = '';
      results.classList.add('show');

      if (!ok) {
        const msg = data.stderr || data.error || 'Unknown error';
        showError(`Analysis failed: ${msg}`);
        return;
      }

      let html = '<div class="success"><h3><span class="material-symbols-outlined">check_circle</span> Analysis Complete!</h3></div>';

      // Add job details toggle right after success message
      let hasJobDetails = data.command || (data.stdout && data.stdout.trim()) || (data.output_files && Object.values(data.output_files).some(file => file.content_preview));
      if (hasJobDetails) {
        html += `
          <button class="job-details-toggle" onclick="this.nextElementSibling.classList.toggle('show'); this.textContent = this.nextElementSibling.classList.contains('show') ? 'Hide job details' : 'Show job details';">Show job details</button>
          <div class="job-details">
            ${data.command ? `
              <div class="card" style="border-left:4px solid #28a745; margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">terminal</span> Command Executed</h4>
                <code style="font-size:12px; word-break:break-all;">${data.command}</code>
              </div>
            ` : ''}
            ${data.stdout && data.stdout.trim() ? `
              <div class="card" style="background:#fff7ed; border-left:4px solid #fb923c; margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">info</span> Notices and warnings</h4>
                <pre style="font-size:12px; white-space:pre-wrap; margin:0;">${data.stdout}</pre>
              </div>
            ` : ''}
            ${data.output_files && Object.values(data.output_files).some(file => file.content_preview) ? `
              <div class="card" style="margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">visibility</span> Lambda Preview</h4>
                ${Object.entries(data.output_files).map(([filename, fileData]) => 
                  fileData.content_preview ? `
                    <div class="muted" style="margin-bottom:8px;">Preview (first 5 lines from Lambda) - ${filename}</div>
                    <pre style="background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto; font-size:11px; line-height:1.4;">${fileData.content_preview}</pre>
                  ` : ''
                ).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }

      // Files section
      if (data.output_files && Object.keys(data.output_files).length > 0) {
        html += '<h3 style="margin-top:8px;">Results</h3>';
        results.innerHTML = html; // mount early so we can append cards

        Object.entries(data.output_files).forEach(([filename, fileData], idx) => {
          const fileSection = document.createElement('div');

          fileSection.innerHTML = `
           <div class="button-container" style="margin-top:12px;margin-bottom:12px;">
              <button class="download-btn" data-action="download"><span class="material-symbols-outlined">download</span> Download ${filename} (${formatFileSize(fileData.size || 0)})</button>
            </div>
            
            <div class="preview-wrap">
              <div class="muted" style="margin-bottom:6px;">Data preview:</div>
              <div class="preview-mount"></div>
            </div>
            
          `;

          // Wire download button and auto-render preview
          const downloadBtn = fileSection.querySelector('button[data-action="download"]');
          const mount = fileSection.querySelector('.preview-mount');

          // Auto-render preview table
          try {
            const text = decompressToText(fileData);
            renderCsvPreview(mount, text, 20);
          } catch (err) {
            mount.innerHTML = `<div class="error">Failed to preview: ${err.message}</div>`;
          }

          downloadBtn.addEventListener('click', () => {
            downloadOutputFile(filename, fileData, outputName);
          });

          results.appendChild(fileSection);
        });
        return;
      }

      // If no files, just show success
      // TODO - we should handle this better, it means something went wrong in Lambda
      results.innerHTML = html;
    }

    // Validation constants
    const MAX_FILE_SIZE = 4.5 * 1024 * 1024; // 4.5MB
    const VALID_PEAK_TYPES = ['BED6', 'MACS2', 'SEACR'];
    const VALID_SPECIES = ['dm6', 'xenTro10', 'hg38', 'hg19', 'mm10', 'mm39', 'susScr11', 'ce11', 'sacCer3', 'danRer11'];
    const VALID_K_VALUES = ['1', '2', '3'];
    const VALID_OUTPUT_TYPES = ['csv', 'xlsx'];

    // Validation functions
    function validateFile(file) {
      if (!file) return { valid: false, message: 'Please select a file' };
      if (file.size > MAX_FILE_SIZE) {
        return { valid: false, message: `File too large (${formatFileSize(file.size)}). Maximum size: ${formatFileSize(MAX_FILE_SIZE)}` };
      }
      const validExtensions = ['.bed', '.narrowpeak', '.txt'];
      const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
      if (!hasValidExtension) {
        return { valid: false, message: 'Invalid file type. Please select a .bed, .narrowPeak, or .txt file' };
      }
      return { valid: true };
    }

    function validatePeakType(value) {
      return VALID_PEAK_TYPES.includes(value);
    }

    function validateSpecies(value) {
      return VALID_SPECIES.includes(value);
    }

    function validateKValue(value) {
      return VALID_K_VALUES.includes(value);
    }

    function validateOutputType(value) {
      return VALID_OUTPUT_TYPES.includes(value);
    }

    function showFieldError(fieldId, message) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    function hideFieldError(fieldId) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      hideFieldError('file');
      
      if (!file) {
        fileLabel.innerHTML = '<span class="material-symbols-outlined">folder_open</span> Choose your peak file...';
        fileLabel.classList.remove('has-file', 'error');
        return;
      }
      
      const validation = validateFile(file);
      const sizeDisplay = formatFileSize(file.size);
      
      if (!validation.valid) {
        fileLabel.innerHTML = `<span class="material-symbols-outlined">error</span> ${file.name} (${sizeDisplay})`;
        fileLabel.classList.remove('has-file');
        fileLabel.classList.add('error');
        showFieldError('file', validation.message);
      } else {
        fileLabel.innerHTML = `<span class="material-symbols-outlined">check_circle</span> ${file.name} (${sizeDisplay})`;
        fileLabel.classList.add('has-file');
        fileLabel.classList.remove('error');
      }
    });

    // Add validation event listeners
    document.querySelectorAll('input[name="peakType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        hideFieldError('peakType');
        if (!validatePeakType(e.target.value)) {
          showFieldError('peakType', 'Invalid peak type selected');
        }
      });
    });

    document.getElementById('species').addEventListener('change', (e) => {
      hideFieldError('species');
      if (!validateSpecies(e.target.value)) {
        showFieldError('species', 'Invalid species selected');
      }
    });

    document.querySelectorAll('input[name="kValue"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        hideFieldError('kValue');
        if (!validateKValue(e.target.value)) {
          showFieldError('kValue', 'Invalid k value selected');
        }
      });
    });

    document.querySelectorAll('input[name="outputType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        hideFieldError('outputType');
        if (!validateOutputType(e.target.value)) {
          showFieldError('outputType', 'Invalid output type selected');
        }
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear all previous errors
      ['file', 'peakType', 'species', 'kValue', 'outputType'].forEach(hideFieldError);
      results.innerHTML = '';
      results.classList.remove('show');
      
      // Validate all fields
      let hasErrors = false;
      
      // Validate file
      const file = fileInput.files[0];
      const fileValidation = validateFile(file);
      if (!fileValidation.valid) {
        showFieldError('file', fileValidation.message);
        hasErrors = true;
      }
      
      // Validate peak type
      const peakTypeElement = document.querySelector('input[name="peakType"]:checked');
      const peakType = peakTypeElement ? peakTypeElement.value : null;
      if (!peakType || !validatePeakType(peakType)) {
        showFieldError('peakType', 'Please select a valid peak type');
        hasErrors = true;
      }
      
      // Validate species
      const species = document.getElementById('species').value;
      if (!validateSpecies(species)) {
        showFieldError('species', 'Please select a valid species');
        hasErrors = true;
      }
      
      // Validate k value
      const kValueElement = document.querySelector('input[name="kValue"]:checked');
      const kValue = kValueElement ? kValueElement.value : null;
      if (!kValue || !validateKValue(kValue)) {
        showFieldError('kValue', 'Please select a valid number of genes (1-3)');
        hasErrors = true;
      }
      
      // Validate output type
      const outputTypeElement = document.querySelector('input[name="outputType"]:checked');
      const outputType = outputTypeElement ? outputTypeElement.value : null;
      if (!outputType || !validateOutputType(outputType)) {
        showFieldError('outputType', 'Please select a valid output format');
        hasErrors = true;
      }
      
      // If there are validation errors, don't proceed
      if (hasErrors) {
        showError('Please fix the validation errors above before submitting.');
        return;
      }

      // Show loading
      loading.classList.add('show');
      submitBtn.disabled = true;

      try {
        // Read file text
        const content = await readFileAsText(file);
        const outputName = '.peakscout';

        const lambdaRequest = {
          command: 'peak2gene',
          args: [
            '--peak_file', file.name,
            '--peak_type', peakType,
            '--species_genome', species,
            '--k', kValue,
            '--output_name', file.name + outputName,
            '--o', 'results/',
            '--output_type', outputType
          ],
          input_files: { [file.name]: content },
          return_files: true,
          debug: false
        };

        const resp = await fetch(LAMBDA_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lambdaRequest)
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }

        const raw = await resp.json();
        displayResults(raw, outputName);
      } catch (err) {
        console.error(err);
        showError(`Error: ${err.message}`);
      } finally {
        loading.classList.remove('show');
        submitBtn.disabled = false;
      }
    });

    // Theme toggle functionality
    let isRetroTheme = false;

    function toggleTheme() {
      isRetroTheme = !isRetroTheme;
      const body = document.body;
      const toggle = document.getElementById('themeToggle');
      const title = document.getElementById('pageTitle');
      
      if (isRetroTheme) {
        body.classList.add('retro-theme');
        toggle.textContent = '🎨 Switch to Clean Theme 🎨';
        title.textContent = '⚡ PEAKSCOUT \'85 ⚡ CYBER GENOMICS TERMINAL';
        // Save preference
        localStorage.setItem('peakscout-theme', 'retro');
      } else {
        body.classList.remove('retro-theme');
        toggle.textContent = '⚡ Switch to Rad 80\'s Theme ⚡';
        title.textContent = 'PeakScout - Annotate your peaks!';
        // Save preference
        localStorage.setItem('peakscout-theme', 'clean');
      }
    }

    // Load saved theme preference on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('peakscout-theme');
      if (savedTheme === 'retro') {
        toggleTheme();
      }
    });
  </script>

  <footer class="footer">
    <p>If you use peakScout for a publication, please cite it! Thank you.</p>
    <p>&copy; 2025 - <a href="https://cds.vanderbilt.edu">Creative Data Solutions</a>, Vanderbilt University</p>
    <p><a href="#" onclick="toggleTheme()" id="themeToggle">👾</a></p>
  </footer>

</body>
</html>