<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PeakScout - Annotate your peaks!</title>
  <meta name="description" content="peakScout is a user-friendly and reversible peak-to-gene translator for genomic peak calling results" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fzstd@0.1.1/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh; padding: 20px; color:#2f2f2f;
  }
  .container { max-width: 800px; margin:0 auto; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.1); overflow:hidden; }
  .header { background:linear-gradient(135deg,#ebe5da,#e8e1cd); color:#4a4a4a; padding:24px 30px; display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 24px; position: relative; }
  .header-logo { 
    width: 120px; 
    height: auto; 
    display: block;
  }
  .header-description { opacity:.9; font-size:15px; margin: 0; }
  .header-links { position: absolute; top: 24px; right: 30px; display: flex; flex-direction: row; gap: 12px; align-items: center; }
  .header-link { color: #4a4a4a; text-decoration: none; font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 6px; background: rgba(255,255,255,0.3); transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px; }
  .header-link:hover { background: rgba(255,255,255,0.5); transform: translateY(-1px); }
  .header-link .material-symbols-outlined { font-size: 16px; }
  
  @media (max-width: 768px) {
    .header { grid-template-columns: 1fr; justify-items: center; gap: 16px; }
    .header-description { grid-column: 1; text-align: center; }
    .header-links { position: static; align-items: center; }
  }
  .form-container { padding:40px; }
  .form-group { margin-bottom:24px; }
  label { display:block; margin-bottom:6px; font-weight:600; color:#4a4a4a; font-size:15px; }
  .form-hint { font-size:13px; color:#6b7280; margin-bottom:8px; }
  input, select { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:8px; font-size:16px; transition: all .2s ease; background:#fff; }
  input:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
  .form-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
  .file-upload { position:relative; display:inline-block; width:100%; }
  .file-upload input[type=file] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
  .file-upload-label { display:flex; align-items:center; justify-content:center; padding:20px; border:2px dashed #d1d5db; border-radius:8px; background:#f9fafb; cursor:pointer; transition:all .2s ease; font-size:15px; }
  .file-upload-label:hover { border-color:#3b82f6; background:#eff6ff; }
  .file-upload-label.has-file { border-color:#10b981; background:#ecfdf5; color:#10b981; }
  .file-upload-label.error { border-color:#ef4444; background:#fef2f2; color:#ef4444; }
  
  /* Radio button styles */
  .radio-group { 
    display: flex; 
    gap: 16px; 
    margin-top: 8px; 
    flex-wrap: nowrap;
    align-items: center;
    min-height: 48px;
  }
  .radio-option {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .radio-option input[type="radio"] {
    width: auto;
    margin: 0;
    cursor: pointer;
    accent-color: #3b82f6;
  }
  .radio-option label {
    margin: 0;
    font-weight: 400;
    cursor: pointer;
    display: inline;
    color: #4a4a4a;
    font-size: 15px;
  }
  
  .submit-btn { width:100%; padding:16px; background:#dbba35; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; margin-top:16px; transition: all .2s ease; }
  .submit-btn:hover { transform:translateY(-1px); box-shadow:0 8px 25px rgba(59,130,246,.3); }
  .submit-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
  .loading { text-align:center; padding:40px; display:none; }
  .loading.show { display:block; }
  .spinner { width:32px; height:32px; border:3px solid #e5e7eb; border-top:3px solid #3b82f6; border-radius:50%; animation: spin 1s linear infinite; margin:0 auto 16px; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  .results { margin-top:20px; padding-top: 10px; border-radius:0 0 16px 16px; display:none; }
  .results.show { display:block; }
  .error { background:#fef2f2; border:1px solid #fecaca; color:#dc2626; padding:16px; border-radius:8px; font-size:15px; }
  .success { background:#f0fdf4; border:1px solid #bbf7d0; color:#166534; padding:16px; border-radius:8px; font-size:15px; }
  .validation-error { color:#dc2626; font-size:13px; margin-top:4px; display:none; }
  .download-btn { background:linear-gradient(45deg,#4d7c50,#2f5d2f); color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; margin: 8px 6px 0 0; }
  .secondary-btn { background:#f4f1e9; color:#5e503f; border:1px solid #d1c7b3; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; margin: 8px 6px 0 0; }
  .card { margin:15px 0; padding:18px; border:2px solid #e5e7eb; border-radius:12px; background:#fff; }

  /* Preview table */
  .preview-wrap { margin-top:14px; border-top:1px solid #e5e7eb; padding-top:12px; }
  .table-scroll { border:1px solid #e5e7eb; border-radius:10px; overflow:auto; max-height:420px; background:#fff; }
  table.preview { width:100%; border-collapse:separate; border-spacing:0; font-size:12px; }
  table.preview thead th { position:sticky; top:0; background:#f4f1e9; border-bottom:1px solid #e5e7eb; padding:10px; text-align:left; font-weight:800; }
  table.preview thead th.closest-col { background:#dbba35; color:#fff; }
  table.preview tbody td { border-bottom:1px solid #f3f4f6; padding:8px 10px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
  .muted { color:#6b7280; font-size:12px; }
    .header .logo {
    max-width: 120px;
    height: auto;
    display: block;
    margin: 0 auto 12px auto;
    }

    .footer {
      text-align: center;
      padding: 10px;
      margin-top: 20px;
      font-size: 14px;
      color: #4a4a4a;
    }
    .footer p {
      margin: 6px 0;
    }

    /* General Material Icons alignment */
    .material-symbols-outlined {
      vertical-align: middle;
      display: inline-block;
      margin-right: 8px;
      font-size: 20px;
      line-height: 1;
    }

    /* Specific alignment for headings */
    h3 .material-symbols-outlined,
    h4 .material-symbols-outlined {
      vertical-align: text-top;
      margin-right: 8px;
    }

    /* Button icon alignment */
    .secondary-btn .material-symbols-outlined,
    .download-btn .material-symbols-outlined,
      .download-btn:hover { transform:translateY(-1px); box-shadow:0 8px 25px rgba(59,130,246,.3); }

    .submit-btn .material-symbols-outlined {
      margin-right: 8px;
      vertical-align: middle;
      font-size: 18px;
    }

    /* File upload label icon alignment */
    .file-upload-label .material-symbols-outlined {
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Button container styling */
    .button-container {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .secondary-btn, .download-btn {
      display: inline-flex;
      align-items: center;
      margin: 0;
      height: 40px;
      box-sizing: border-box;
    }

  /* Icon alignment within buttons */
  .secondary-btn .material-symbols-outlined,
  .download-btn .material-symbols-outlined {
    font-size: 18px;
    line-height: 1;
  }

  /* Job details toggle */
  .job-details-toggle {
    background: none;
    border: none;
    color: #3b82f6;
    cursor: pointer;
    font-size: 14px;
    text-decoration: underline;
    margin: 12px 0;
    padding: 0;
  }
  .job-details-toggle:hover {
    color: #1d4ed8;
  }
  .job-details {
    display: none;
  }
  .job-details.show {
    display: block;
  }

  p small { font-size:12px; color:#6b7280; margin-bottom:20px; padding-bottom:20px; }

  @media (max-width: 820px) { .form-row { grid-template-columns:1fr; } }
</style>

</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.svg" alt="PeakScout Logo" class="header-logo" />
      <p class="header-description">peakScout is a user-friendly and reversible peak-to-gene translator for genomic peak calling results</p>
      <div class="header-links">
        <a href="#" class="header-link" title="Research article (coming soon)">
          <span class="material-symbols-outlined">article</span>
          DOI
        </a>
        <a href="https://github.com/vandydata/peakScout" class="header-link" title="View source code">
          <span class="material-symbols-outlined">code</span>
          GitHub
        </a>
      </div>
    </div>

    <div class="form-container">
      <form id="peakscoutForm">
        <div class="form-group">
          <label for="peakFile">Peak File</label>
          <div class="form-hint">Select MACS2, SEACR or BED file (max 4.5 MB)</div>
          <div class="file-upload">
            <input type="file" id="peakFile" accept=".bed,.narrowPeak,.txt" required />
            <div class="file-upload-label" id="fileLabel"><span class="material-symbols-outlined">folder_open</span> Choose your peak file...</div>
          </div>
          <div class="validation-error" id="fileError">Please select a valid file under 4.5 MB</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="peakType">Peak Type</label>
            <div class="form-hint">Select your peak caller format</div>
            <select id="peakType" required>
              <option value="BED6">BED6</option>
              <option value="MACS2">MACS2</option>
              <option value="SEACR">SEACR</option>
            </select>
            <div class="validation-error" id="peakTypeError">Please select a valid peak type</div>
          </div>
          <div class="form-group">
            <label>Number of Nearest Genes</label>
            <div class="form-hint">How many genes per peak</div>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="kValue1" name="kValue" value="1" required checked />
                <label for="kValue1">1</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="kValue2" name="kValue" value="2" required />
                <label for="kValue2">2</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="kValue3" name="kValue" value="3" required />
                <label for="kValue3">3</label>
              </div>
            </div>
            <div class="validation-error" id="kValueError">Please select a valid number of genes (1-3)</div>
          </div>
          <div class="form-group">
            <label for="species">Species</label>
            <div class="form-hint">Reference genome used</div>
            <select id="species" required>
              <option value="dm6">Fruitfly (dm6)</option>
              <option value="xenTro10">Frog (xenTro10)</option>
              <option value="hg38" selected>Human (hg38)</option>
              <option value="hg19">Human (hg19)</option>
              <option value="mm10">Mouse (mm10)</option>
              <option value="mm39">Mouse (mm39)</option>
              <option value="susScr11">Pig (susScr11)</option>
              <option value="ce11">Worm (ce11)</option>
              <option value="sacCer3">Yeast (sacCer3)</option>
              <option value="danRer11">Zebrafish (danRer11)</option>
            </select>
            <div class="validation-error" id="speciesError">Please select a valid species</div>
          </div>
        </div>

        <div class="form-row">
          
          <!--<div class="form-group">
            <label for="outputName">Output Name</label>
            <input type="text" id="outputName" value=".peakscout" required />
          </div>-->
        </div>

        <button type="submit" class="submit-btn" id="submitBtn"><span class="material-symbols-outlined">search_insights</span> Run PeakScout Analysis</button>
      </form>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Running PeakScout analysis...</p>
        <small class="muted">This may take a few minutes</small>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <script>
    // Configuration
    // For local SAM: 'http://localhost:9000/2015-03-31/functions/function/invocations'
    // For API Gateway/Lambda URL: set to your deployed endpoint
    //const LAMBDA_ENDPOINT = 'http://localhost:9000/2015-03-31/functions/function/invocations';
    const LAMBDA_ENDPOINT = 'https://kc5rbxi6ve2fdvajzwvcdkeigi0hsnkb.lambda-url.us-east-1.on.aws/';

    // DOM 
    const form = document.getElementById('peakscoutForm');
    const fileInput = document.getElementById('peakFile');
    const fileLabel = document.getElementById('fileLabel');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');

    // Utilities
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024, sizes = ['Bytes','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
    function b64ToBytes(b64) { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
    function bytesToText(bytes) { return new TextDecoder().decode(bytes); }

    function unwrapLambda(result) {
      // Handle outer API Gateway/Lambda Proxy envelope
      if (result && typeof result === 'object' && 'body' in result) {
        if (result.isBase64Encoded) {
          const compressed = b64ToBytes(result.body);
          const jsonStr = pako.ungzip(compressed, { to: 'string' });
          return JSON.parse(jsonStr);
        }
        if (typeof result.body === 'string') {
          try { return JSON.parse(result.body); } catch { return result; }
        }
      }
      // Already unwrapped (local invoke)
      return result;
    }

    function saveTextAsCsv(filename, text) {
      const blob = new Blob([text], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename.endsWith('.csv') ? filename : `${filename}.csv`;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Decompress content_compressed payload to text
    function decompressToText(fileData) {
      if (!fileData) throw new Error('missing file data');

      // Compressed content path
      if (fileData.content_compressed && typeof fileData.content === 'string') {
        const bytes = b64ToBytes(fileData.content);
        if (fileData.compression_type === 'zstd') {
          const decompressed = fzstd.decompress(bytes);
          return bytesToText(decompressed);
        }
        if (fileData.compression_type === 'gzip') {
          return pako.ungzip(bytes, { to: 'string' });
        }
        // Unknown compression label. try raw text decode
        return bytesToText(bytes);
      }

      // Plain text path
      if (fileData.type === 'text' && typeof fileData.content === 'string') {
        return fileData.content;
      }

      // Boom!
      throw new Error('Not a text-CSV artifact (binary or unknown type).');
    }

    // Render CSV preview table (first N rows)
    function renderCsvPreview(container, csvText, rowLimit = 20) {
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    const rows = parsed.data.slice(0, rowLimit);

    if (!rows.length) {
      container.innerHTML = '<div class="muted">(No rows to preview)</div>';
      return;
    }

    // Determine field order (prefer Papa's meta, fallback to keys from first row)
    const fields = (parsed.meta && parsed.meta.fields && parsed.meta.fields.length)
      ? parsed.meta.fields
      : Object.keys(rows[0] || {});

    // Build table
    const tableWrap = document.createElement('div');
    tableWrap.className = 'table-scroll';
    const table = document.createElement('table');
    table.className = 'preview';

    // Header
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    fields.forEach((f) => {
      const th = document.createElement('th');
      th.textContent = f;
      if (f.toLowerCase().startsWith('closest_')) {
        th.classList.add('closest-col');
      }
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);

    // Body
    const tbody = document.createElement('tbody');
    rows.forEach((r) => {
      const tr = document.createElement('tr');
      // If r is an object (header:true), pull values by field name
      // If it somehow ends up an array, fall back to index acces
      fields.forEach((f, idx) => {
        const td = document.createElement('td');
        const val = (r && typeof r === 'object' && !Array.isArray(r)) ? r[f] : (r?.[idx]);
        td.title = (val ?? '').toString();
        td.textContent = (val ?? '').toString();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    // Inject into container
    container.innerHTML = '';
    container.appendChild(tableWrap);
    tableWrap.appendChild(table);
  }

    async function downloadOutputFile(filename, fileData, fallbackName='results') {
      try {
        // Binary base64 path
        if (fileData.type === 'binary_base64' && typeof fileData.content === 'string') {
          const b = b64ToBytes(fileData.content);
          const blob = new Blob([b]);
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename || `${fallbackName}.bin`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          return;
        }

        // Text path (possibly compressed)
        const text = decompressToText(fileData);
        saveTextAsCsv(filename || `${fallbackName}.csv`, text);
      } catch (err) {
        console.error('Download failed:', err);
        alert(`Failed to download ${filename}: ${err.message}`);
      }
    }

    function showError(message) {
      results.innerHTML = `<div class="error"><h3><span class="material-symbols-outlined">error</span> Error</h3><p>${message}</p></div>`;
      results.classList.add('show');
    }

    function displayResults(raw, outputName) {
      const data = unwrapLambda(raw);

      // If inner object has returncode, use it; else assume OK (local dev variants)
      const ok = (typeof data.returncode === 'number') ? (data.returncode === 0) : true;
      results.innerHTML = '';
      results.classList.add('show');

      if (!ok) {
        const msg = data.stderr || data.error || 'Unknown error';
        showError(`Analysis failed: ${msg}`);
        return;
      }

      let html = '<div class="success"><h3><span class="material-symbols-outlined">check_circle</span> Analysis Complete!</h3></div>';

      // Add job details toggle right after success message
      let hasJobDetails = data.command || (data.stdout && data.stdout.trim()) || (data.output_files && Object.values(data.output_files).some(file => file.content_preview));
      if (hasJobDetails) {
        html += `
          <button class="job-details-toggle" onclick="this.nextElementSibling.classList.toggle('show'); this.textContent = this.nextElementSibling.classList.contains('show') ? 'Hide job details' : 'Show job details';">Show job details</button>
          <div class="job-details">
            ${data.command ? `
              <div class="card" style="border-left:4px solid #28a745; margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">terminal</span> Command Executed</h4>
                <code style="font-size:12px; word-break:break-all;">${data.command}</code>
              </div>
            ` : ''}
            ${data.stdout && data.stdout.trim() ? `
              <div class="card" style="background:#fff7ed; border-left:4px solid #fb923c; margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">info</span> Notices and warnings</h4>
                <pre style="font-size:12px; white-space:pre-wrap; margin:0;">${data.stdout}</pre>
              </div>
            ` : ''}
            ${data.output_files && Object.values(data.output_files).some(file => file.content_preview) ? `
              <div class="card" style="margin-bottom:12px;">
                <h4><span class="material-symbols-outlined">visibility</span> Lambda Preview</h4>
                ${Object.entries(data.output_files).map(([filename, fileData]) => 
                  fileData.content_preview ? `
                    <div class="muted" style="margin-bottom:8px;">Preview (first 5 lines from Lambda) - ${filename}</div>
                    <pre style="background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto; font-size:11px; line-height:1.4;">${fileData.content_preview}</pre>
                  ` : ''
                ).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }

      // Files section
      if (data.output_files && Object.keys(data.output_files).length > 0) {
        html += '<h3 style="margin-top:8px;">Results</h3>';
        results.innerHTML = html; // mount early so we can append cards

        Object.entries(data.output_files).forEach(([filename, fileData], idx) => {
          const fileSection = document.createElement('div');

          fileSection.innerHTML = `
           <div class="button-container" style="margin-top:12px;margin-bottom:12px;">
              <button class="download-btn" data-action="download"><span class="material-symbols-outlined">download</span> Download ${filename} (${formatFileSize(fileData.size || 0)})</button>
            </div>
            
            <div class="preview-wrap">
              <div class="muted" style="margin-bottom:6px;">Data preview:</div>
              <div class="preview-mount"></div>
            </div>
            
          `;

          // Wire download button and auto-render preview
          const downloadBtn = fileSection.querySelector('button[data-action="download"]');
          const mount = fileSection.querySelector('.preview-mount');

          // Auto-render preview table
          try {
            const text = decompressToText(fileData);
            renderCsvPreview(mount, text, 20);
          } catch (err) {
            mount.innerHTML = `<div class="error">Failed to preview: ${err.message}</div>`;
          }

          downloadBtn.addEventListener('click', () => {
            downloadOutputFile(filename, fileData, outputName);
          });

          results.appendChild(fileSection);
        });
        return;
      }

      // If no files, just show success
      // TODO - we should handle this better, it means something went wrong in Lambda
      results.innerHTML = html;
    }

    // Validation constants
    const MAX_FILE_SIZE = 4.5 * 1024 * 1024; // 4.5MB
    const VALID_PEAK_TYPES = ['BED6', 'MACS2', 'SEACR'];
    const VALID_SPECIES = ['dm6', 'xenTro10', 'hg38', 'hg19', 'mm10', 'mm39', 'susScr11', 'ce11', 'sacCer3', 'danRer11'];
    const VALID_K_VALUES = ['1', '2', '3'];

    // Validation functions
    function validateFile(file) {
      if (!file) return { valid: false, message: 'Please select a file' };
      if (file.size > MAX_FILE_SIZE) {
        return { valid: false, message: `File too large (${formatFileSize(file.size)}). Maximum size: ${formatFileSize(MAX_FILE_SIZE)}` };
      }
      const validExtensions = ['.bed', '.narrowpeak', '.txt'];
      const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
      if (!hasValidExtension) {
        return { valid: false, message: 'Invalid file type. Please select a .bed, .narrowPeak, or .txt file' };
      }
      return { valid: true };
    }

    function validatePeakType(value) {
      return VALID_PEAK_TYPES.includes(value);
    }

    function validateSpecies(value) {
      return VALID_SPECIES.includes(value);
    }

    function validateKValue(value) {
      return VALID_K_VALUES.includes(value);
    }

    function showFieldError(fieldId, message) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    function hideFieldError(fieldId) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      hideFieldError('file');
      
      if (!file) {
        fileLabel.innerHTML = '<span class="material-symbols-outlined">folder_open</span> Choose your peak file...';
        fileLabel.classList.remove('has-file', 'error');
        return;
      }
      
      const validation = validateFile(file);
      const sizeDisplay = formatFileSize(file.size);
      
      if (!validation.valid) {
        fileLabel.innerHTML = `<span class="material-symbols-outlined">error</span> ${file.name} (${sizeDisplay})`;
        fileLabel.classList.remove('has-file');
        fileLabel.classList.add('error');
        showFieldError('file', validation.message);
      } else {
        fileLabel.innerHTML = `<span class="material-symbols-outlined">check_circle</span> ${file.name} (${sizeDisplay})`;
        fileLabel.classList.add('has-file');
        fileLabel.classList.remove('error');
      }
    });

    // Add validation event listeners
    document.getElementById('peakType').addEventListener('change', (e) => {
      hideFieldError('peakType');
      if (!validatePeakType(e.target.value)) {
        showFieldError('peakType', 'Invalid peak type selected');
      }
    });

    document.getElementById('species').addEventListener('change', (e) => {
      hideFieldError('species');
      if (!validateSpecies(e.target.value)) {
        showFieldError('species', 'Invalid species selected');
      }
    });

    document.querySelectorAll('input[name="kValue"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        hideFieldError('kValue');
        if (!validateKValue(e.target.value)) {
          showFieldError('kValue', 'Invalid k value selected');
        }
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear all previous errors
      ['file', 'peakType', 'species', 'kValue'].forEach(hideFieldError);
      results.innerHTML = '';
      results.classList.remove('show');
      
      // Validate all fields
      let hasErrors = false;
      
      // Validate file
      const file = fileInput.files[0];
      const fileValidation = validateFile(file);
      if (!fileValidation.valid) {
        showFieldError('file', fileValidation.message);
        hasErrors = true;
      }
      
      // Validate peak type
      const peakType = document.getElementById('peakType').value;
      if (!validatePeakType(peakType)) {
        showFieldError('peakType', 'Please select a valid peak type');
        hasErrors = true;
      }
      
      // Validate species
      const species = document.getElementById('species').value;
      if (!validateSpecies(species)) {
        showFieldError('species', 'Please select a valid species');
        hasErrors = true;
      }
      
      // Validate k value
      const kValueElement = document.querySelector('input[name="kValue"]:checked');
      const kValue = kValueElement ? kValueElement.value : null;
      if (!kValue || !validateKValue(kValue)) {
        showFieldError('kValue', 'Please select a valid number of genes (1-3)');
        hasErrors = true;
      }
      
      // If there are validation errors, don't proceed
      if (hasErrors) {
        showError('Please fix the validation errors above before submitting.');
        return;
      }

      // Show loading
      loading.classList.add('show');
      submitBtn.disabled = true;

      try {
        // Read file text
        const content = await readFileAsText(file);
        const outputName = '.peakscout';

        const lambdaRequest = {
          command: 'peak2gene',
          args: [
            '--peak_file', file.name,
            '--peak_type', peakType,
            '--species', species,
            '--k', kValue,
            '--output_name', file.name + outputName,
            '--o', 'results/',
            '--output_type', 'csv'
          ],
          input_files: { [file.name]: content },
          return_files: true,
          debug: false
        };

        const resp = await fetch(LAMBDA_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lambdaRequest)
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }

        const raw = await resp.json();
        displayResults(raw, outputName);
      } catch (err) {
        console.error(err);
        showError(`Error: ${err.message}`);
      } finally {
        loading.classList.remove('show');
        submitBtn.disabled = false;
      }
    });
  </script>

  <footer class="footer">
    <p>If you use peakScout for a publication, please cite it! Thank you.</p>
    <p>&copy; 2025 - <a href="https://cds.vanderbilt.edu">Creative Data Solutions</a>, Vanderbilt University</p>
  </footer>

</body>
</html>